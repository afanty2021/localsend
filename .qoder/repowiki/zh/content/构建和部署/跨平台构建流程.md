# 跨平台构建流程

<cite>
**本文档中引用的文件**  
- [compile_android_apk.sh](file://scripts/compile_android_apk.sh)
- [compile_android_appbundle.ps1](file://scripts/compile_android_appbundle.ps1)
- [compile_ios.sh](file://scripts/compile_ios.sh)
- [compile_linux_appimage.sh](file://scripts/compile_linux_appimage.sh)
- [compile_windows_exe.ps1](file://scripts/compile_windows_exe.ps1)
- [compile_windows_msix_store.ps1](file://scripts/compile_windows_msix_store.ps1)
- [compile_mac_dmg.sh](file://scripts/compile_mac_dmg.sh)
- [compile_mac_appstore.sh](file://scripts/compile_mac_appstore.sh)
- [pubspec.yaml](file://app/pubspec.yaml)
- [build.yaml](file://app/build.yaml)
- [android/build.gradle](file://app/android/build.gradle)
- [ios/Podfile](file://app/ios/Podfile)
- [linux/CMakeLists.txt](file://app/linux/CMakeLists.txt)
- [windows/CMakeLists.txt](file://app/windows/CMakeLists.txt)
- [Cargo.toml](file://app/rust/Cargo.toml)
- [AppImageBuilder_x86_64.yml](file://scripts/appimage/AppImageBuilder_x86_64.yml)
- [AppImageBuilder_arm_64.yml](file://scripts/appimage/AppImageBuilder_arm_64.yml)
- [compile_windows_exe-inno.iss](file://scripts/compile_windows_exe-inno.iss)
- [msix/AppxManifest.xml](file://msix/AppxManifest.xml)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构概述](#架构概述)
5. [详细组件分析](#详细组件分析)
6. [依赖分析](#依赖分析)
7. [性能考虑](#性能考虑)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)
10. [附录](#附录)

## 简介
本文件详细说明了LocalSend应用程序的跨平台构建流程。该应用程序使用Flutter框架开发，支持Android、iOS、Windows、macOS和Linux平台。文档涵盖了各个平台的构建命令、依赖要求、配置选项以及构建脚本的工作原理。同时解释了不同构建类型之间的差异，并提供了构建输出的目录结构说明和产物文件用途解释。

## 项目结构
LocalSend项目采用模块化结构，主要分为以下几个部分：app（主应用程序）、cli（命令行工具）、common（共享代码）、core（Rust核心库）、server（服务器端）和scripts（构建脚本）。这种结构使得代码组织清晰，便于维护和扩展。

```mermaid
graph TD
A[项目根目录] --> B[app]
A --> C[cli]
A --> D[common]
A --> E[core]
A --> F[server]
A --> G[scripts]
A --> H[msix]
A --> I[fastlane]
A --> J[readme_i18n]
B --> K[android]
B --> L[ios]
B --> M[linux]
B --> N[macos]
B --> O[windows]
B --> P[lib]
B --> Q[rust]
B --> R[rust_builder]
G --> S[appimage]
G --> T[msix]
```

**图示来源**
- [app](file://app)
- [scripts](file://scripts)

**章节来源**
- [项目结构](file://)

## 核心组件
应用程序的核心组件包括Flutter前端界面、Rust后端逻辑、共享的common模块以及平台特定的集成代码。这些组件通过flutter_rust_bridge进行通信，实现了高性能的跨平台功能。

**章节来源**
- [app/pubspec.yaml](file://app/pubspec.yaml#L1-L123)
- [app/rust/Cargo.toml](file://app/rust/Cargo.toml#L1-L17)

## 架构概述
LocalSend采用分层架构设计，前端使用Flutter构建用户界面，后端使用Rust处理网络通信和文件传输等核心功能。通过flutter_rust_bridge实现Dart与Rust之间的高效通信。各平台的原生功能通过Flutter插件集成。

```mermaid
graph TB
subgraph "前端"
UI[Flutter用户界面]
State[状态管理]
end
subgraph "桥接层"
FRB[Flutter Rust Bridge]
end
subgraph "后端"
Core[Rust核心库]
Crypto[加密模块]
Network[网络模块]
end
UI --> FRB
State --> FRB
FRB --> Core
Core --> Crypto
Core --> Network
```

**图示来源**
- [app/pubspec.yaml](file://app/pubspec.yaml#L1-L123)
- [app/rust/Cargo.toml](file://app/rust/Cargo.toml#L1-L17)

## 详细组件分析

### Android构建分析
Android平台的构建支持APK和AAB两种格式，分别用于常规安装和Google Play发布。构建过程需要特定的环境配置和依赖项。

#### Android构建脚本
```mermaid
flowchart TD
Start([开始构建]) --> CheckEnv["检查环境依赖"]
CheckEnv --> SetupEnv["设置Android SDK"]
SetupEnv --> CloneRepo["克隆代码库"]
CloneRepo --> UpdateSubmodule["更新子模块"]
UpdateSubmodule --> SetFlutter["设置Flutter别名"]
SetFlutter --> DisableAnalytics["禁用分析"]
DisableAnalytics --> PubGet["获取依赖包"]
PubGet --> BuildRunner["运行构建生成器"]
BuildRunner --> BuildApk["构建APK"]
BuildApk --> End([完成])
style Start fill:#f9f,stroke:#333
style End fill:#bbf,stroke:#333
```

**图示来源**
- [scripts/compile_android_apk.sh](file://scripts/compile_android_apk.sh#L1-L31)

**章节来源**
- [scripts/compile_android_apk.sh](file://scripts/compile_android_apk.sh#L1-L31)
- [scripts/compile_android_appbundle.ps1](file://scripts/compile_android_appbundle.ps1#L1-L10)
- [app/android/build.gradle](file://app/android/build.gradle#L1-L34)

### iOS构建分析
iOS平台的构建需要macOS环境和Xcode工具链。支持DMG分发和App Store发布两种方式，每种方式有不同的签名和打包要求。

#### iOS构建流程
```mermaid
sequenceDiagram
participant Dev as 开发者
participant Flutter as Flutter工具
participant Xcode as Xcode
participant Apple as Apple服务
Dev->>Flutter : 执行构建脚本
Flutter->>Flutter : 清理构建目录
Flutter->>Flutter : 获取依赖包
Flutter->>Flutter : 预缓存iOS组件
Flutter->>Xcode : 执行pod update
Xcode->>Xcode : 更新CocoaPods依赖
Flutter->>Flutter : 构建IPA文件
Flutter->>Dev : 输出构建结果
opt 应用分发
Dev->>Xcode : 深度签名应用
Xcode->>Apple : 提交公证服务
Apple->>Xcode : 返回公证结果
Xcode->>Dev : 生成最终DMG
end
```

**图示来源**
- [scripts/compile_ios.sh](file://scripts/compile_ios.sh#L1-L13)
- [scripts/compile_mac_dmg.sh](file://scripts/compile_mac_dmg.sh#L1-L53)

**章节来源**
- [scripts/compile_ios.sh](file://scripts/compile_ios.sh#L1-L13)
- [scripts/compile_mac_dmg.sh](file://scripts/compile_mac_dmg.sh#L1-L53)
- [app/ios/Podfile](file://app/ios/Podfile#L1-L48)

### Linux构建分析
Linux平台使用AppImage格式进行分发，确保在不同发行版上的兼容性。构建过程包括创建应用目录、打包和签名等步骤。

#### Linux构建流程
```mermaid
flowchart TD
A([开始Linux构建]) --> B["安装依赖 (clang, cmake, libgtk-3-dev)"]
B --> C["安装AppImage工具"]
C --> D["清理临时目录"]
D --> E["复制项目到临时目录"]
E --> F["更新Git子模块"]
F --> G["设置Flutter别名"]
G --> H["清理Flutter构建"]
H --> I["获取Dart包"]
I --> J["运行构建生成器"]
J --> K["构建Linux应用"]
K --> L["创建AppDir目录"]
L --> M["复制构建产物"]
M --> N["运行appimage-builder"]
N --> O["设置可执行权限"]
O --> P["清理临时文件"]
P --> Q([完成])
classDef startEnd fill:#f9f,stroke:#333;
class A,Q startEnd;
```

**图示来源**
- [scripts/compile_linux_appimage.sh](file://scripts/compile_linux_appimage.sh#L1-L39)

**章节来源**
- [scripts/compile_linux_appimage.sh](file://scripts/compile_linux_appimage.sh#L1-L39)
- [scripts/appimage/AppImageBuilder_x86_64.yml](file://scripts/appimage/AppImageBuilder_x86_64.yml)
- [app/linux/CMakeLists.txt](file://app/linux/CMakeLists.txt#L1-L139)

### Windows构建分析
Windows平台支持多种分发格式，包括EXE安装程序、MSIX包和ZIP压缩包。每种格式针对不同的分发渠道和用户需求。

#### Windows构建类型
```mermaid
graph TD
A[Windows构建] --> B[EXE安装程序]
A --> C[MSIX包]
A --> D[ZIP压缩包]
B --> E[使用Inno Setup]
B --> F[包含所有依赖]
B --> G[标准安装流程]
C --> H[应用商店版本]
C --> I[企业签名版本]
C --> J[自签名版本]
D --> K[便携式版本]
D --> L[直接运行]
D --> M[无需安装]
style A fill:#ff9999,stroke:#333;
style B fill:#99ff99,stroke:#333;
style C fill:#99ff99,stroke:#333;
style D fill:#99ff99,stroke:#333;
```

**图示来源**
- [scripts/compile_windows_exe.ps1](file://scripts/compile_windows_exe.ps1#L1-L19)
- [scripts/compile_windows_msix_store.ps1](file://scripts/compile_windows_msix_store.ps1#L1-L12)

**章节来源**
- [scripts/compile_windows_exe.ps1](file://scripts/compile_windows_exe.ps1#L1-L19)
- [scripts/compile_windows_msix_store.ps1](file://scripts/compile_windows_msix_store.ps1#L1-L12)
- [app/windows/CMakeLists.txt](file://app/windows/CMakeLists.txt#L1-L108)
- [scripts/compile_windows_exe-inno.iss](file://scripts/compile_windows_exe-inno.iss)

### 构建配置分析
构建配置通过YAML文件和Gradle/Podfile等平台特定文件进行管理，确保各平台的一致性和可维护性。

#### 构建配置关系
```mermaid
classDiagram
class Pubspec {
+String name
+String description
+String version
+Map dependencies
+Map dev_dependencies
+FlutterConfig flutter
}
class BuildYaml {
+String base_locale
+String fallback_strategy
+String input_directory
+String input_file_pattern
+Boolean timestamp
+Map format
}
class AndroidGradle {
+Integer compileSdkVersion
+String buildToolsVersion
+List repositories
}
class Podfile {
+String platform
+String project_config
+List pods
}
class CMakeLists {
+String cmake_minimum_required
+String project_name
+List targets
+List dependencies
}
Pubspec --> BuildYaml : "使用"
Pubspec --> AndroidGradle : "配置Android"
Pubspec --> Podfile : "配置iOS"
Pubspec --> CMakeLists : "配置桌面平台"
```

**图示来源**
- [app/pubspec.yaml](file://app/pubspec.yaml#L1-L123)
- [app/build.yaml](file://app/build.yaml#L1-L22)
- [app/android/build.gradle](file://app/android/build.gradle#L1-L34)
- [app/ios/Podfile](file://app/ios/Podfile#L1-L48)
- [app/linux/CMakeLists.txt](file://app/linux/CMakeLists.txt#L1-L139)
- [app/windows/CMakeLists.txt](file://app/windows/CMakeLists.txt#L1-L108)

**章节来源**
- [app/pubspec.yaml](file://app/pubspec.yaml#L1-L123)
- [app/build.yaml](file://app/build.yaml#L1-L22)

## 依赖分析
项目依赖分为Dart/Flutter依赖、Rust依赖和平台特定依赖三大部分。通过合理的依赖管理，确保了跨平台的一致性和性能优化。

```mermaid
graph LR
A[Dart/Flutter依赖] --> B[基本工具]
A --> C[平台集成]
A --> D[UI组件]
A --> E[网络通信]
F[Rust依赖] --> G[核心功能]
F --> H[异步处理]
F --> I[错误处理]
F --> J[日志记录]
K[平台特定依赖] --> L[Android SDK]
K --> M[iOS CocoaPods]
K --> N[Linux GTK+]
K --> O[Windows API]
style A fill:#ccf,stroke:#333;
style F fill:#ccf,stroke:#333;
style K fill:#ccf,stroke:#333;
```

**图示来源**
- [app/pubspec.yaml](file://app/pubspec.yaml#L1-L123)
- [app/rust/Cargo.toml](file://app/rust/Cargo.toml#L1-L17)

**章节来源**
- [app/pubspec.yaml](file://app/pubspec.yaml#L1-L123)
- [app/rust/Cargo.toml](file://app/rust/Cargo.toml#L1-L17)

## 性能考虑
构建过程中的性能优化主要体现在以下几个方面：构建缓存、代码压缩、资源优化和并行构建。

### 构建性能优化策略
```mermaid
flowchart TD
A[性能优化] --> B[构建缓存]
A --> C[代码压缩]
A --> D[资源优化]
A --> E[并行构建]
B --> F[Gradle缓存]
B --> G[CocoaPods缓存]
B --> H[Flutter构建缓存]
C --> I[Dart代码混淆]
C --> J[Rust代码优化]
C --> K[资源压缩]
D --> L[图片优化]
D --> M[字体子集]
D --> N[语言文件分割]
E --> O[并行任务执行]
E --> P[分布式构建]
E --> Q[增量构建]
style A fill:#f96,stroke:#333;
style B fill:#69f,stroke:#333;
style C fill:#69f,stroke:#333;
style D fill:#69f,stroke:#333;
style E fill:#69f,stroke:#333;
```

**图示来源**
- [app/pubspec.yaml](file://app/pubspec.yaml#L1-L123)
- [scripts/compile_android_apk.sh](file://scripts/compile_android_apk.sh#L1-L31)

## 故障排除指南
针对常见的构建失败场景，提供以下故障排除建议：

### 常见构建问题及解决方案
```mermaid
graph TD
A[构建失败] --> B{平台}
B --> C[Android]
B --> D[iOS]
B --> E[Linux]
B --> F[Windows]
B --> G[macOS]
C --> H["缺少Android SDK"]
C --> I["Gradle版本不兼容"]
C --> J["签名配置错误"]
D --> K["Xcode版本过旧"]
D --> L["证书无效"]
D --> M["CocoaPods问题"]
E --> N["缺少GTK依赖"]
E --> O["AppImage工具未安装"]
E --> P["权限问题"]
F --> Q["Visual Studio未安装"]
F --> R["Inno Setup缺失"]
F --> S["路径过长"]
G --> T["代码签名失败"]
G --> U["公证服务错误"]
G --> V["磁盘空间不足"]
style A fill:#f66,stroke:#333,color:#fff;
style H,V fill:#ff9,stroke:#333;
```

**章节来源**
- [scripts/compile_android_apk.sh](file://scripts/compile_android_apk.sh#L1-L31)
- [scripts/compile_ios.sh](file://scripts/compile_ios.sh#L1-L13)
- [scripts/compile_linux_appimage.sh](file://scripts/compile_linux_appimage.sh#L1-L39)
- [scripts/compile_windows_exe.ps1](file://scripts/compile_windows_exe.ps1#L1-L19)
- [scripts/compile_mac_dmg.sh](file://scripts/compile_mac_dmg.sh#L1-L53)

## 结论
LocalSend的跨平台构建流程设计完善，支持多种平台和分发渠道。通过标准化的构建脚本和配置文件，确保了构建过程的可重复性和可靠性。建议开发者遵循文档中的指导，正确配置构建环境，以避免常见的构建问题。

## 附录
### 构建脚本参数说明
- **compile_android_apk.sh**: 用于生成可重现构建的APK文件，适合F-Droid等开源市场
- **compile_android_appbundle.ps1**: 生成Android App Bundle格式，用于Google Play发布
- **compile_ios.sh**: 构建iOS IPA文件，准备App Store或企业分发
- **compile_linux_appimage.sh**: 创建跨发行版兼容的AppImage文件
- **compile_windows_exe.ps1**: 生成使用Inno Setup的Windows安装程序
- **compile_windows_msix_store.ps1**: 创建适用于Microsoft Store的MSIX包
- **compile_mac_dmg.sh**: 生成签名并经过公证的macOS DMG安装包
- **compile_mac_appstore.sh**: 构建用于Mac App Store提交的应用程序

这些脚本共同构成了LocalSend完整的跨平台构建体系，支持从开发到发布的整个生命周期。