# 核心库编译

<cite>
**本文档中引用的文件**  
- [app/rust/Cargo.toml](file://app/rust/Cargo.toml)
- [core/Cargo.toml](file://core/Cargo.toml)
- [server/Cargo.toml](file://server/Cargo.toml)
- [app/rust_builder/cargokit/run_build_tool.sh](file://app/rust_builder/cargokit/run_build_tool.sh)
- [app/rust_builder/cargokit/run_build_tool.cmd](file://app/rust_builder/cargokit/run_build_tool.cmd)
- [app/rust_builder/cargokit/build_tool/lib/src/build_tool.dart](file://app/rust_builder/cargokit/build_tool/lib/src/build_tool.dart)
- [app/rust_builder/android/build.gradle](file://app/rust_builder/android/build.gradle)
- [app/rust_builder/linux/CMakeLists.txt](file://app/rust_builder/linux/CMakeLists.txt)
- [app/rust_builder/windows/CMakeLists.txt](file://app/rust_builder/windows/CMakeLists.txt)
- [app/rust/Cargo.lock](file://app/rust/Cargo.lock)
- [core/Cargo.lock](file://core/Cargo.lock)
- [server/Cargo.lock](file://server/Cargo.lock)
- [app/rust_builder/cargokit/README](file://app/rust_builder/cargokit/README)
- [app/rust_builder/pubspec.yaml](file://app/rust_builder/pubspec.yaml)
- [app/rust_builder/cargokit/build_pod.sh](file://app/rust_builder/cargokit/build_pod.sh)
</cite>

## 目录
1. [项目结构](#项目结构)
2. [核心模块配置](#核心模块配置)
3. [Rust模块配置](#rust模块配置)
4. [编译流程](#编译流程)
5. [构建目标配置](#构建目标配置)
6. [cargokit构建工具](#cargokit构建工具)
7. [常见编译错误](#常见编译错误)
8. [构建性能优化](#构建性能优化)

## 项目结构

本项目包含多个Rust核心库模块，主要分为三个部分：app/rust、core和server。每个部分都有独立的Cargo.toml配置文件，形成了清晰的模块化结构。

```mermaid
graph TD
A[项目根目录] --> B[app/rust]
A --> C[core]
A --> D[server]
A --> E[app/rust_builder]
B --> F[Cargo.toml]
C --> G[Cargo.toml]
D --> H[Cargo.toml]
E --> I[cargokit]
E --> J[android]
E --> K[linux]
E --> L[windows]
```

**图示来源**
- [app/rust/Cargo.toml](file://app/rust/Cargo.toml)
- [core/Cargo.toml](file://core/Cargo.toml)
- [server/Cargo.toml](file://server/Cargo.toml)
- [app/rust_builder/android/build.gradle](file://app/rust_builder/android/build.gradle)
- [app/rust_builder/linux/CMakeLists.txt](file://app/rust_builder/linux/CMakeLists.txt)
- [app/rust_builder/windows/CMakeLists.txt](file://app/rust_builder/windows/CMakeLists.txt)

**章节来源**
- [app/rust/Cargo.toml](file://app/rust/Cargo.toml)
- [core/Cargo.toml](file://core/Cargo.toml)
- [server/Cargo.toml](file://server/Cargo.toml)

## 核心模块配置

core模块是整个项目的基础库，提供了核心功能的实现。其Cargo.toml文件定义了丰富的依赖项和特性开关，支持灵活的功能组合。

```toml
[package]
name = "localsend"
version = "0.1.0"
edition = "2021"

[dependencies]
anyhow = "1.0.100"
base64 = "0.22.1"
bytes = "1.9.1"
ed25519-dalek = { version = "2.2.0", features = ["pem", "rand_core"], optional = true }
flate2 = { version = "1.1.4", optional = true }
futures-util = { version = "0.3.31", features = ["sink"] }
http-body-util = { version = "0.1.3", optional = true }
hyper = { version = "1.7.0", optional = true }
hyper-util = { version = "0.1.17", features = ["server"], optional = true }
lru = "0.16.1"
pem = { version = "3.0.6", optional = true }
reqwest = { version = "0.12.23", features = ["charset", "http2", "system-proxy", "json", "rustls-tls-webpki-roots-no-provider", "stream"], default-features = false, optional = true }
rand = "0.9.1"
rsa = { version = "0.9.7", optional = true }
rustls = { version = "0.23.32", default-features = false, features = ["ring", "tls12", "std"], optional = true }
serde = { version = "1.0.228", features = ["derive"] }
serde_json = "1.0.145"
sha2 = { version = "0.10.9", optional = true }
thiserror = "2.0.17"
tokio = { version = "1.46.1", features = ["full"] }
tokio-rustls = { version = "0.26.4", default-features = false, features = ["ring", "tls12"], optional = true }
tokio-stream = "0.1.7"
tokio-tungstenite = { version = "0.28.0", features = ["rustls-tls-webpki-roots"], optional = true }
tracing = "0.1.41"
tracing-subscriber = { version = "0.3.20" }
tungstenite = "0.28.0"
uuid = { version = "1.18.1", features = ["serde", "v4"] }
webrtc = { version = "0.13.0", optional = true }
x509-parser = { version = "0.17.0", features = ["verify"], optional = true }

[features]
default = []
crypto = ["ed25519-dalek", "rsa", "sha2"]
http = ["crypto", "http-body-util", "hyper", "hyper-util", "pem", "reqwest", "rustls", "tokio-rustls", "x509-parser"]
webrtc-signaling = ["tokio-tungstenite"]
webrtc = ["crypto", "flate2", "dep:webrtc", "webrtc-signaling", "x509-parser"]
full = ["crypto", "http", "webrtc"]
```

**章节来源**
- [core/Cargo.toml](file://core/Cargo.toml)

## Rust模块配置

app/rust模块是应用程序的Rust绑定层，负责与Flutter前端进行交互。其Cargo.toml文件配置了特定的库类型和依赖项，以支持跨平台集成。

```toml
[package]
name = "rust_lib_localsend_app"
version = "0.1.0"
edition = "2021"

[lib]
crate-type = ["cdylib", "staticlib"]

[dependencies]
anyhow = "1.0.95"
bytes = "1.9.0"
flutter_rust_bridge = { version = "=2.11.1", features = ["uuid"] }
localsend = { path = "../../core", features = ["full"] }
tokio = { version = "1.43.0", features = ["full"] }
tracing = "0.1.41"
tracing-subscriber = { version = "0.3.19" }
uuid = { version = "1.11.1", features = ["v4"] }
```

**章节来源**
- [app/rust/Cargo.toml](file://app/rust/Cargo.toml)

## 编译流程

Rust代码的编译流程从源码到生成静态库，涉及多个步骤和工具的协同工作。整个流程由cargokit构建工具管理，确保跨平台构建的一致性。

```mermaid
sequenceDiagram
participant 开发者 as 开发者
participant 构建脚本 as 构建脚本
participant Cargo as Cargo
participant 编译器 as Rust编译器
participant 输出 as 输出文件
开发者->>构建脚本 : 执行构建命令
构建脚本->>Cargo : 调用Cargo构建
Cargo->>编译器 : 编译Rust源码
编译器->>编译器 : 处理依赖项
编译器->>编译器 : 生成目标文件
编译器->>编译器 : 链接静态库
编译器->>输出 : 生成cdylib和staticlib
输出->>构建脚本 : 返回构建结果
构建脚本->>开发者 : 显示构建状态
```

**图示来源**
- [app/rust/Cargo.toml](file://app/rust/Cargo.toml)
- [app/rust_builder/cargokit/run_build_tool.sh](file://app/rust_builder/cargokit/run_build_tool.sh)
- [app/rust_builder/cargokit/run_build_tool.cmd](file://app/rust_builder/cargokit/run_build_tool.cmd)

**章节来源**
- [app/rust/Cargo.toml](file://app/rust/Cargo.toml)
- [app/rust_builder/cargokit/run_build_tool.sh](file://app/rust_builder/cargokit/run_build_tool.sh)
- [app/rust_builder/cargokit/run_build_tool.cmd](file://app/rust_builder/cargokit/run_build_tool.cmd)

## 构建目标配置

项目支持多种构建目标，包括debug和release模式，以及不同的优化级别。这些配置通过Cargo.toml文件和构建脚本进行管理。

```mermaid
graph TD
A[构建配置] --> B[Debug模式]
A --> C[Release模式]
B --> D[无优化]
B --> E[调试符号]
B --> F[快速编译]
C --> G[优化级别2]
C --> H[移除调试符号]
C --> I[代码大小优化]
A --> J[自定义配置]
J --> K[目标平台]
J --> L[特性开关]
J --> M[依赖版本]
```

**图示来源**
- [app/rust/Cargo.toml](file://app/rust/Cargo.toml)
- [core/Cargo.toml](file://core/Cargo.toml)
- [server/Cargo.toml](file://server/Cargo.toml)

**章节来源**
- [app/rust/Cargo.toml](file://app/rust/Cargo.toml)
- [core/Cargo.toml](file://core/Cargo.toml)
- [server/Cargo.toml](file://server/Cargo.toml)

## cargokit构建工具

cargokit是本项目使用的构建工具，它与Cargo集成，实现了跨平台构建。该工具通过Dart脚本包装Cargo命令，提供了统一的构建接口。

```mermaid
classDiagram
class BuildTool {
+runMain(args)
+initLogging()
+enableVerboseLogging()
}
class BuildCommand {
+runBuildCommand(options)
+run()
}
class BuildPodCommand {
+name = "build-pod"
+description = "Build cocoa pod library"
+runBuildCommand(options)
}
class BuildGradleCommand {
+name = "build-gradle"
+description = "Build android library"
+runBuildCommand(options)
}
class BuildCMakeCommand {
+name = "build-cmake"
+description = "Build CMake library"
+runBuildCommand(options)
}
class GenKeyCommand {
+name = "gen-key"
+description = "Generate key pair for signing"
+run()
}
BuildTool --> BuildCommand : "包含"
BuildCommand <|-- BuildPodCommand
BuildCommand <|-- BuildGradleCommand
BuildCommand <|-- BuildCMakeCommand
BuildTool --> GenKeyCommand
```

**图示来源**
- [app/rust_builder/cargokit/build_tool/lib/src/build_tool.dart](file://app/rust_builder/cargokit/build_tool/lib/src/build_tool.dart)
- [app/rust_builder/cargokit/run_build_tool.sh](file://app/rust_builder/cargokit/run_build_tool.sh)
- [app/rust_builder/cargokit/run_build_tool.cmd](file://app/rust_builder/cargokit/run_build_tool.cmd)

**章节来源**
- [app/rust_builder/cargokit/build_tool/lib/src/build_tool.dart](file://app/rust_builder/cargokit/build_tool/lib/src/build_tool.dart)
- [app/rust_builder/cargokit/run_build_tool.sh](file://app/rust_builder/cargokit/run_build_tool.sh)
- [app/rust_builder/cargokit/run_build_tool.cmd](file://app/rust_builder/cargokit/run_build_tool.cmd)

## 常见编译错误

在编译过程中可能会遇到各种错误，主要包括依赖冲突、平台特定代码编译失败等问题。以下是常见错误及其解决方案。

```mermaid
flowchart TD
Start([开始编译]) --> CheckDependencies["检查依赖项"]
CheckDependencies --> DependenciesOK{"依赖项正常?"}
DependenciesOK --> |否| ResolveConflicts["解决依赖冲突"]
DependenciesOK --> |是| CompileCode["编译代码"]
CompileCode --> PlatformSpecific{"平台特定代码?"}
PlatformSpecific --> |是| CheckPlatform["检查平台兼容性"]
PlatformSpecific --> |否| LinkLibraries["链接库文件"]
CheckPlatform --> PlatformOK{"平台兼容?"}
PlatformOK --> |否| FixPlatformCode["修复平台特定代码"]
PlatformOK --> |是| LinkLibraries
LinkLibraries --> GenerateOutput["生成输出文件"]
GenerateOutput --> End([编译完成])
ResolveConflicts --> CompileCode
FixPlatformCode --> CompileCode
```

**图示来源**
- [app/rust/Cargo.lock](file://app/rust/Cargo.lock)
- [core/Cargo.lock](file://core/Cargo.lock)
- [server/Cargo.lock](file://server/Cargo.lock)

**章节来源**
- [app/rust/Cargo.lock](file://app/rust/Cargo.lock)
- [core/Cargo.lock](file://core/Cargo.lock)
- [server/Cargo.lock](file://server/Cargo.lock)

## 构建性能优化

为了提高构建性能，项目采用了多种优化策略，包括增量编译配置和依赖缓存策略。

```mermaid
graph TD
A[构建性能优化] --> B[增量编译]
A --> C[依赖缓存]
A --> D[并行构建]
B --> E[仅编译更改的文件]
B --> F[缓存编译结果]
C --> G[本地Cargo缓存]
C --> H[CI/CD缓存]
D --> I[多线程编译]
D --> J[并行任务执行]
A --> K[配置优化]
K --> L[调整优化级别]
K --> M[减少依赖项]
```

**图示来源**
- [app/rust/Cargo.toml](file://app/rust/Cargo.toml)
- [core/Cargo.toml](file://core/Cargo.toml)
- [server/Cargo.toml](file://server/Cargo.toml)

**章节来源**
- [app/rust/Cargo.toml](file://app/rust/Cargo.toml)
- [core/Cargo.toml](file://core/Cargo.toml)
- [server/Cargo.toml](file://server/Cargo.toml)