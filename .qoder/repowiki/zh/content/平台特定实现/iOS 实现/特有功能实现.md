# 特有功能实现

<cite>
**本文档中引用的文件**  
- [AppDelegate.swift](file://app/ios/Runner/AppDelegate.swift)
- [ShareViewController.swift](file://app/ios/ShareExtension/ShareViewController.swift)
- [Info.plist](file://app/ios/Runner/Info.plist)
- [ShareExtension/Info.plist](file://app/ios/ShareExtension/Info.plist)
- [ios_channel.dart](file://app/lib/util/native/ios_channel.dart)
- [macos_channel.dart](file://app/lib/util/native/macos_channel.dart)
- [IosLocalNetworkDialog.dart](file://app/lib/widget/dialogs/ios_network_permission_dialog.dart)
- [Podfile](file://app/ios/Podfile)
- [ShareExtension.entitlements](file://app/ios/ShareExtension/ShareExtension.entitlements)
</cite>

## 目录
1. [简介](#简介)
2. [应用生命周期管理](#应用生命周期管理)
3. [分享扩展实现机制](#分享扩展实现机制)
4. [状态栏图标与后台模式](#状态栏图标与后台模式)
5. [文件共享与权限配置](#文件共享与权限配置)
6. [网络唤醒与本地网络权限](#网络唤醒与本地网络权限)
7. [总结](#总结)

## 简介
本项目在iOS平台上实现了多项特有功能，包括应用生命周期管理、分享扩展、状态栏图标控制、后台任务处理以及本地网络通信等。通过原生Swift代码与Flutter的Method Channel通信机制，实现了对iOS系统特性的深度集成。本文档将详细解析这些功能的实现原理与配置方法。

## 应用生命周期管理
应用通过`AppDelegate.swift`文件管理iOS应用的生命周期。在`application:didFinishLaunchingWithOptions`方法中，应用初始化Flutter引擎并注册方法通道（Method Channel），用于处理原生与Flutter之间的通信。

应用通过名为`ios-delegate-channel`的方法通道，实现了对iOS系统特性的访问。目前主要实现了`isReduceMotionEnabled`方法，用于检测用户是否启用了减少动画效果的辅助功能设置。该功能在Flutter端通过`isReduceMotionEnabledIOS()`方法调用，为应用提供无障碍支持。

```swift
@objc class AppDelegate: FlutterAppDelegate {
  override func application(
    _ application: UIApplication,
    didFinishLaunchingWithOptions launchOptions: [UIApplication.LaunchOptionsKey: Any]?
  ) -> Bool {
    let controller : FlutterViewController = window?.rootViewController as! FlutterViewController
    let engine = controller.engine
    let channel = FlutterMethodChannel(
      name: "ios-delegate-channel",
      binaryMessenger: engine.binaryMessenger
    )
    channel.setMethodCallHandler { (call: FlutterMethodCall, result: @escaping FlutterResult) in
      if call.method == "isReduceMotionEnabled" {
        result(UIAccessibility.isReduceMotionEnabled)
      } else {
        result(FlutterMethodNotImplemented)
      }
    }
    GeneratedPluginRegistrant.register(with: self)
    return super.application(application, didFinishLaunchingWithOptions: launchOptions)
  }
}
```

**Section sources**
- [AppDelegate.swift](file://app/ios/Runner/AppDelegate.swift#L1-L29)
- [ios_channel.dart](file://app/lib/util/native/ios_channel.dart#L1-L8)

## 分享扩展实现机制
分享扩展（Share Extension）是iOS平台的重要功能，允许用户从其他应用分享内容到本应用。本项目通过`ShareExtension`目标实现此功能，其核心文件为`ShareViewController.swift`。

分享扩展的实现基于`share_handler_ios_models`库，`ShareViewController`类继承自`ShareHandlerIosViewController`，这是一个由第三方库提供的基类，负责处理分享扩展的大部分逻辑。这种设计简化了分享功能的实现，开发者无需处理复杂的文件共享和权限管理细节。

```swift
import share_handler_ios_models
    
class ShareViewController: ShareHandlerIosViewController {}
```

在`Podfile`中，项目配置了分享扩展所需的依赖：

```ruby
target 'ShareExtension' do
  inherit! :search_paths
  pod "share_handler_ios_models", :path => ".symlinks/plugins/share_handler_ios/ios/Models"
end
```

分享扩展的配置主要在`Info.plist`文件中完成，定义了扩展支持的内容类型：

```xml
<key>NSExtensionAttributes</key>
<dict>
  <key>NSExtensionActivationRule</key>
  <dict>
    <key>NSExtensionActivationSupportsWebPageWithMaxCount</key>
    <integer>999</integer>
    <key>NSExtensionActivationSupportsWebURLWithMaxCount</key>
    <integer>999</integer>
    <key>NSExtensionActivationSupportsMovieWithMaxCount</key>
    <integer>999</integer>
    <key>NSExtensionActivationSupportsImageWithMaxCount</key>
    <integer>999</integer>
    <key>NSExtensionActivationSupportsFileWithMaxCount</key>
    <integer>999</integer>
    <key>NSExtensionActivationSupportsAttachmentsWithMaxCount</key>
    <integer>999</integer>
    <key>NSExtensionActivationSupportsText</key>
    <true/>
  </dict>
  <key>PHSupportedMediaTypes</key>
  <array>
    <string>Video</string>
    <string>Image</string>
  </array>
</dict>
```

上述配置表明分享扩展支持网页、URL、视频、图片、文件、附件和文本等多种内容类型的分享，且每种类型最多支持999个项目。`PHSupportedMediaTypes`指定了相册中支持的媒体类型。

在Flutter端，应用通过`share_handler`插件处理分享意图。在应用初始化时，会检查是否有初始分享内容，并订阅分享流以处理后续的分享请求：

```dart
final initialSharedPayload = await shareHandler.getInitialSharedMedia();
if (initialSharedPayload != null) {
  hasInitialShare = true;
  ref.global.dispatchAsync(_HandleShareIntentAction(
    payload: initialSharedPayload,
  ));
}

_sharedMediaSubscription = shareHandler.sharedMediaStream.listen((SharedMedia payload) async {
  await ref.global.dispatchAsync(_HandleShareIntentAction(
    payload: payload,
  ));
});
```

**Section sources**
- [ShareViewController.swift](file://app/ios/ShareExtension/ShareViewController.swift#L1-L4)
- [ShareExtension/Info.plist](file://app/ios/ShareExtension/Info.plist#L1-L41)
- [Podfile](file://app/ios/Podfile#L40-L44)
- [config/init.dart](file://app/lib/config/init.dart#L249-L292)

## 状态栏图标与后台模式
虽然项目主要针对iOS平台，但状态栏图标的实现主要在macOS版本中完成。在`macos_channel.dart`中，定义了`setupStatusBar()`方法，用于在macOS上设置状态栏图标：

```dart
Future<void> setupStatusBar() async {
  await _methodChannel.invokeMethod('setupStatusBar', {
    'open': t.tray.open,
    'quit': t.tray.close,
  });
}
```

在`AppDelegate.swift`（macOS版本）中，`setupStatusBarItem`方法负责创建状态栏项目：

```swift
private func setupStatusBarItem(i18n: [String: String]) {
    statusItem = NSStatusBar.system.statusItem(withLength: NSStatusItem.squareLength)
    if let button = statusItem.button {
        let image = NSImage(named: "StatusBarItemIcon")
        image?.size = NSSize(width: 18, height: 18)
        button.image = image
        button.action = #selector(statusBarButtonClicked)
        button.sendAction(on: [.leftMouseUp, .rightMouseUp])
    }
    buildStatusBarMenu(i18n: i18n)
}
```

对于iOS平台，虽然没有直接的状态栏图标实现，但应用通过其他方式实现后台运行和持续服务。项目通过配置`Info.plist`中的后台模式来支持后台任务：

```xml
<key>UIBackgroundModes</key>
<array>
  <string>fetch</string>
  <string>processing</string>
</array>
```

这些后台模式允许应用在后台定期获取数据和执行处理任务，确保文件传输等长时间操作能够顺利完成。

**Section sources**
- [macos_channel.dart](file://app/lib/util/native/macos_channel.dart#L1-L10)
- [AppDelegate.swift](file://app/macos/Runner/AppDelegate.swift#L73-L76)
- [tray_helper.dart](file://app/lib/util/native/tray_helper.dart#L1-L42)

## 文件共享与权限配置
iOS应用的文件共享功能通过`Info.plist`文件中的特定键值配置实现。项目配置了多个与文件共享相关的权限和功能：

```xml
<!-- Make downloaded files visible to the user -->
<key>UISupportsDocumentBrowser</key>
<true/>

<!-- Make documents files visible to the Finder/AppleDevices app -->
<key>UIFileSharingEnabled</key>
<true/>
<key>LSSupportsOpeningDocumentsInPlace</key>
<true/>
```

上述配置启用了文档浏览器支持、文件共享功能和就地打开文档功能，使用户能够通过"文件"应用访问应用内的文件。

应用还配置了必要的权限描述，这些描述会在请求相应权限时显示给用户：

```xml
<key>NSPhotoLibraryUsageDescription</key>
<string>The app needs photo library access so that the user can select photos to share.</string>
<key>NSPhotoLibraryAddUsageDescription</key>
<string>The app saves received media to the photo library.</string>
<key>NSLocationAlwaysAndWhenInUseUsageDescription</key>
<string>The app requires the local IP to communicate.</string>
<key>NSLocationWhenInUseUsageDescription</key>
<string>The app requires the local IP to communicate.</string>
<key>NSLocalNetworkUsageDescription</key>
<string>The app uses the local network to find and connect to nearby devices.</string>
```

分享扩展的权限通过`entitlements`文件配置，使用应用组（App Groups）实现主应用与扩展之间的数据共享：

```xml
<key>com.apple.security.application-groups</key>
<array>
  <string>group.org.localsend.localsendApp</string>
</array>
```

这种配置允许分享扩展将接收到的文件存储在共享容器中，主应用可以访问这些文件，实现跨进程的数据交换。

**Section sources**
- [Info.plist](file://app/ios/Runner/Info.plist#L1-L155)
- [ShareExtension.entitlements](file://app/ios/ShareExtension/ShareExtension.entitlements#L1-L11)

## 网络唤醒与本地网络权限
应用的本地网络通信功能是其核心特性之一，允许设备在局域网内发现和连接。这一功能在iOS 14及以上版本中需要特殊的权限配置。

项目在`Info.plist`中配置了本地网络使用描述和Bonjour服务：

```xml
<key>NSLocalNetworkUsageDescription</key>
<string>The app uses the local network to find and connect to nearby devices.</string>
<key>NSBonjourServices</key>
<array>
  <string>_http._tcp</string>
  <string>_bonjour._tcp</string>
  <string>_lnp._tcp.</string>
</array>
```

当应用检测到本地网络权限未授权时，会显示一个自定义对话框，引导用户前往设置页面开启权限：

```dart
class IosLocalNetworkDialog extends StatelessWidget {
  const IosLocalNetworkDialog({super.key});

  @override
  Widget build(BuildContext context) {
    return CustomBottomSheet(
      title: t.dialogs.localNetworkUnauthorized.title,
      description: t.dialogs.localNetworkUnauthorized.description,
      child: Row(
        mainAxisAlignment: MainAxisAlignment.spaceEvenly,
        children: [
          TextButton(
            onPressed: () => context.pop(),
            child: Text(t.general.close),
          ),
          ElevatedButton.icon(
            onPressed: () async => SystemSettings.app(),
            icon: const Icon(Icons.settings),
            label: Text(t.dialogs.localNetworkUnauthorized.gotoSettings),
          ),
        ],
      ),
    );
  }
}
```

应用通过`system_settings`插件实现跳转到系统设置页面的功能，提升用户体验。这种设计符合iOS的人机界面指南，当权限被拒绝时，应用不会反复请求权限，而是引导用户手动开启。

**Section sources**
- [Info.plist](file://app/ios/Runner/Info.plist#L1-L155)
- [ios_network_permission_dialog.dart](file://app/lib/widget/dialogs/ios_network_permission_dialog.dart#L1-L30)
- [Podfile](file://app/ios/Podfile#L1-L47)

## 总结
本项目在iOS平台上实现了完整的特有功能集成，包括应用生命周期管理、分享扩展、文件共享、状态栏控制和本地网络通信等。通过合理的原生与Flutter混合开发架构，项目充分利用了iOS系统的各项特性，为用户提供流畅的跨设备文件传输体验。

关键实现要点包括：
- 使用Method Channel实现原生与Flutter的双向通信
- 通过`share_handler`插件简化分享扩展的实现
- 在`Info.plist`中正确配置各项权限和功能
- 使用应用组实现主应用与扩展之间的数据共享
- 提供友好的权限请求和错误处理机制

这些实现确保了应用在iOS平台上的稳定性和用户体验，同时遵循了苹果的开发规范和隐私保护要求。