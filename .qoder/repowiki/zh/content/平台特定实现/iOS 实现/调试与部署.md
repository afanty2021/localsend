# 调试与部署

<cite>
**本文档中引用的文件**
- [Podfile](file://app/ios/Podfile)
- [Podfile.lock](file://app/ios/Podfile.lock)
- [Info.plist](file://app/ios/Runner/Info.plist)
- [project.pbxproj](file://app/ios/Runner.xcodeproj/project.pbxproj)
- [IDEWorkspaceChecks.plist](file://app/ios/Runner.xcworkspace/xcshareddata/IDEWorkspaceChecks.plist)
- [compile_ios.sh](file://scripts/compile_ios.sh)
- [ios_network_permission_dialog.dart](file://app/lib/widget/dialogs/ios_network_permission_dialog.dart)
</cite>

## 目录
1. [简介](#简介)
2. [Xcode项目配置](#xcode项目配置)
3. [证书与Provisioning Profile管理](#证书与provisioning-profile管理)
4. [权限与网络配置](#权限与网络配置)
5. [iOS特定问题调试](#ios特定问题调试)
6. [App Store发布流程](#app-store发布流程)
7. [IDEWorkspaceChecks.plist的作用](#ideworkspacechecksplist的作用)
8. [构建与部署脚本](#构建与部署脚本)

## 简介
本指南详细介绍了LocalSend应用在iOS平台上的调试与部署流程。涵盖了从Xcode项目配置、证书管理到App Store发布的完整过程。文档重点介绍了iOS特有的配置要求，如权限设置、网络访问和后台传输等关键问题的解决方案。

## Xcode项目配置
LocalSend应用的iOS项目配置遵循标准的Flutter项目结构。项目最低支持iOS 12.0版本，使用Swift 5.0编写，并配置了自动管理签名。项目包含主应用目标（Runner）和分享扩展目标（ShareExtension）。

Xcode项目通过CocoaPods管理依赖，Podfile中定义了平台版本和构建配置。项目使用模块化头文件和框架，并为分享扩展配置了特定的构建设置。

**Section sources**
- [Podfile](file://app/ios/Podfile#L1-L48)
- [project.pbxproj](file://app/ios/Runner.xcodeproj/project.pbxproj#L0-L846)

## 证书与Provisioning Profile管理
项目配置使用自动签名管理（Automatic Code Signing），开发团队标识为3W7H4PYMCV。Xcode会自动处理证书和Provisioning Profile的配置，确保应用可以在开发设备上正确安装和运行。

对于发布版本，系统会生成相应的发布配置，包括正确的代码签名标识和发布证书。项目禁用了Bitcode以简化构建过程，并配置了适当的运行时搜索路径。

**Section sources**
- [project.pbxproj](file://app/ios/Runner.xcodeproj/project.pbxproj#L0-L846)

## 权限与网络配置
LocalSend应用需要多种权限来实现其功能，这些权限在Info.plist文件中明确定义：

- **照片库访问**：允许用户选择要分享的照片（NSPhotoLibraryUsageDescription）
- **照片库写入**：保存接收到的媒体文件到照片库（NSPhotoLibraryAddUsageDescription）
- **位置访问**：获取本地IP地址进行通信（NSLocationWhenInUseUsageDescription）
- **本地网络访问**：发现和连接附近设备（NSLocalNetworkUsageDescription）

应用还声明了Bonjour服务，用于设备发现：
```xml
<key>NSBonjourServices</key>
<array>
    <string>_http._tcp</string>
    <string>_bonjour._tcp</string>
    <string>_lnp._tcp.</string>
</array>
```

**Section sources**
- [Info.plist](file://app/ios/Runner/Info.plist#L0-L154)

## iOS特定问题调试
### 网络权限对话框不显示
当应用缺少本地网络权限时，系统不会自动显示权限请求对话框。开发者需要引导用户手动在设置中启用权限。应用提供了专门的对话框来处理此情况：

```dart
class IosLocalNetworkDialog extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return CustomBottomSheet(
      title: t.dialogs.localNetworkUnauthorized.title,
      description: t.dialogs.localNetworkUnauthorized.description,
      child: ElevatedButton.icon(
        onPressed: () async => SystemSettings.app(),
        icon: const Icon(Icons.settings),
        label: Text(t.dialogs.localNetworkUnauthorized.gotoSettings),
      ),
    );
  }
}
```

### 后台传输中断
iOS系统对后台任务有严格限制。应用通过适当的后台模式配置和任务管理来确保文件传输的连续性。当应用进入后台时，系统会给予有限的时间完成传输任务。

**Section sources**
- [ios_network_permission_dialog.dart](file://app/lib/widget/dialogs/ios_network_permission_dialog.dart#L0-L30)
- [Info.plist](file://app/ios/Runner/Info.plist#L0-L154)

## App Store发布流程
### 元数据准备
发布前需要准备完整的应用元数据，包括：
- 应用名称和副标题
- 应用描述（支持多语言）
- 截图和预览视频
- 关键字和类别
- 营销URL和支持URL

### 审核注意事项
LocalSend应用需注意以下审核要点：
- 应用不包含加密功能，已正确声明ITSAppUsesNonExemptEncryption为false
- 分享扩展功能符合App Store指南
- 应用权限请求合理且有明确用途说明
- 用户数据处理符合隐私政策要求

### 版本管理
应用版本号通过FLUTTER_BUILD_NAME和FLUTTER_BUILD_NUMBER变量管理，与Flutter项目的版本配置同步。每次发布都需要递增版本号以满足App Store的要求。

**Section sources**
- [Info.plist](file://app/ios/Runner/Info.plist#L0-L154)

## IDEWorkspaceChecks.plist的作用
IDEWorkspaceChecks.plist文件用于配置Xcode工作区的一致性检查。在LocalSend项目中，该文件包含以下设置：

```xml
<?xml version="1.0" encoding="UTF-8"?>
<plist version="1.0">
<dict>
	<key>IDEDidComputeMac32BitWarning</key>
	<true/>
</dict>
</plist>
```

此配置记录了Xcode已完成Mac 32位警告的计算，避免在每次打开项目时重复执行此检查。该文件帮助维护开发环境的一致性，确保团队成员使用相同的项目检查设置。

**Section sources**
- [IDEWorkspaceChecks.plist](file://app/ios/Runner.xcworkspace/xcshareddata/IDEWorkspaceChecks.plist#L0-L8)

## 构建与部署脚本
项目提供了自动化构建脚本compile_ios.sh，用于简化iOS应用的构建过程：

```bash
cd app
fvm flutter clean
fvm flutter pub get
fvm flutter precache --ios
(
	cd ios
	pod update
)
fvm flutter build ipa
cd ..
```

该脚本执行以下步骤：
1. 清理项目并获取依赖
2. 预缓存iOS构建所需资源
3. 更新CocoaPods依赖
4. 构建IPA文件

此脚本确保了构建环境的一致性，是持续集成流程的重要组成部分。

**Section sources**
- [compile_ios.sh](file://scripts/compile_ios.sh#L0-L13)