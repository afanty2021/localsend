# 构建与部署流程

<cite>
**本文档中引用的文件**  
- [compile_mac_dmg.sh](file://scripts/compile_mac_dmg.sh)
- [compile_mac_appstore.sh](file://scripts/compile_mac_appstore.sh)
- [Podfile](file://app/macos/Podfile)
- [Podfile.lock](file://app/macos/Podfile.lock)
- [Release.entitlements](file://app/macos/Runner/Release.entitlements)
- [DebugProfile.entitlements](file://app/macos/Runner/DebugProfile.entitlements)
- [pubspec.yaml](file://app/pubspec.yaml)
- [build_pod.sh](file://app/rust_builder/cargokit/build_pod.sh)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心构建脚本分析](#核心构建脚本分析)
4. [依赖管理机制](#依赖管理机制)
5. [代码签名与安全配置](#代码签名与安全配置)
6. [构建变体配置差异](#构建变体配置差异)
7. [常见构建错误排查](#常见构建错误排查)
8. [结论](#结论)

## 简介
本指南详细说明了LocalSend项目在macOS平台上的完整构建和部署流程。涵盖了从开发到发布的全流程，包括Podfile中依赖库的管理机制、DMG镜像和App Store发布包的生成步骤、Apple Developer证书和Provisioning Profile的配置方法，以及不同构建变体的配置差异和常见构建错误的排查方案。

## 项目结构
LocalSend项目的目录结构清晰，主要包含应用代码、脚本、服务器代码和构建工具等部分。macOS相关的构建配置和脚本位于`app/macos`和`scripts`目录下。

**Section sources**
- [project_structure](file://project_structure)

## 核心构建脚本分析

### DMG镜像构建流程
`compile_mac_dmg.sh`脚本用于构建可分发的DMG安装包，包含完整的代码签名、公证和加签流程。

```mermaid
flowchart TD
A[清理项目] --> B[获取依赖]
B --> C[构建macOS应用]
C --> D[深度代码签名]
D --> E[创建DMG镜像]
E --> F[签名DMG文件]
F --> G[提交Apple公证]
G --> H[加签确认]
H --> I[完成构建]
```

**Diagram sources**
- [compile_mac_dmg.sh](file://scripts/compile_mac_dmg.sh#L1-L53)

**Section sources**
- [compile_mac_dmg.sh](file://scripts/compile_mac_dmg.sh#L1-L53)

### App Store发布包构建流程
`compile_mac_appstore.sh`脚本用于构建App Store版本的应用程序，流程相对简化。

```mermaid
flowchart TD
A[清理项目] --> B[获取依赖]
B --> C[构建macOS应用]
C --> D[完成构建]
```

**Diagram sources**
- [compile_mac_appstore.sh](file://scripts/compile_mac_appstore.sh#L1-L9)

**Section sources**
- [compile_mac_appstore.sh](file://scripts/compile_mac_appstore.sh#L1-L9)

## 依赖管理机制

### Podfile依赖配置
macOS平台使用CocoaPods管理原生依赖，Podfile中定义了目标平台和具体依赖库。

```mermaid
classDiagram
class Podfile {
+platform : osx, '11.0'
+project 'Runner'
+target 'Runner'
+post_install
}
class Dependencies {
+flutter_install_all_macos_pods
+pod 'Defaults', '~> 4.2'
}
Podfile --> Dependencies : "includes"
```

**Diagram sources**
- [Podfile](file://app/macos/Podfile#L1-L46)

**Section sources**
- [Podfile](file://app/macos/Podfile#L1-L46)
- [Podfile.lock](file://app/macos/Podfile.lock#L1-L175)

### 关键依赖库及其功能
根据Podfile.lock文件，项目依赖多个关键库：

```mermaid
erDiagram
USER_INTERFACE ||--o{ WINDOW_MANAGER : "bitsdojo_window_macos"
NETWORK ||--o{ CONNECTIVITY_PLUS : "connectivity_plus"
STORAGE ||--o{ SHARED_PREFERENCES : "shared_preferences_foundation"
MEDIA ||--o{ VIDEO_PLAYER : "video_player_avfoundation"
DEVICE_INFO ||--o{ DEVICE_INFO_PLUS : "device_info_plus"
FILE_ACCESS ||--o{ FILE_SELECTOR : "file_selector_macos"
SYSTEM_TRAY ||--o{ TRAY_MANAGER : "tray_manager"
CLIPBOARD ||--o{ PASTEBOARD : "pasteboard"
DEFAULTS ||--o{ DEFAULTS_LIB : "Defaults 4.2.2"
```

**Section sources**
- [Podfile.lock](file://app/macos/Podfile.lock#L1-L175)
- [pubspec.yaml](file://app/pubspec.yaml#L1-L124)

## 代码签名与安全配置

### Entitlements权限配置
应用程序通过Entitlements文件声明所需的安全权限和沙盒配置。

```mermaid
flowchart TD
A[Release.entitlements] --> B[启用应用沙盒]
A --> C[配置应用组]
A --> D[允许书签访问]
A --> E[下载目录读写]
A --> F[用户选择文件读写]
A --> G[网络客户端权限]
A --> H[网络服务器权限]
I[DebugProfile.entitlements] --> J[启用应用沙盒]
I --> K[配置应用组]
I --> L[允许JIT执行]
I --> M[下载目录读写]
I --> N[用户选择文件读写]
I --> O[网络客户端权限]
I --> P[网络服务器权限]
```

**Diagram sources**
- [Release.entitlements](file://app/macos/Runner/Release.entitlements#L1-L23)
- [DebugProfile.entitlements](file://app/macos/Runner/DebugProfile.entitlements#L1-L23)

**Section sources**
- [Release.entitlements](file://app/macos/Runner/Release.entitlements#L1-L23)
- [DebugProfile.entitlements](file://app/macos/Runner/DebugProfile.entitlements#L1-L23)

### 代码签名流程
完整的代码签名流程包括应用签名、DMG签名、Apple公证和加签确认。

```mermaid
sequenceDiagram
participant Developer as 开发者
participant Local as 本地构建系统
participant Apple as Apple服务器
Developer->>Local : 执行compile_mac_dmg.sh
Local->>Local : 深度代码签名应用
Local->>Local : 创建DMG镜像
Local->>Local : 签名DMG文件
Local->>Apple : 提交公证请求
Apple-->>Local : 公证结果
Local->>Local : 加签确认
Local-->>Developer : 完成构建
```

**Section sources**
- [compile_mac_dmg.sh](file://scripts/compile_mac_dmg.sh#L1-L53)

## 构建变体配置差异

### 不同构建环境的配置
项目通过不同的配置文件区分开发、测试和发布环境。

```mermaid
graph TB
subgraph "构建配置"
Debug[调试构建]
Profile[性能分析构建]
Release[发布构建]
end
subgraph "配置文件"
DebugXcconfig[Debug.xcconfig]
ReleaseXcconfig[Release.xcconfig]
FlutterDebug[Flutter-Debug.xcconfig]
FlutterRelease[Flutter-Release.xcconfig]
end
Debug --> DebugXcconfig
Debug --> FlutterDebug
Release --> ReleaseXcconfig
Release --> FlutterRelease
Profile --> DebugXcconfig
Profile --> FlutterDebug
```

**Section sources**
- [Flutter-Release.xcconfig](file://app/macos/Flutter/Flutter-Release.xcconfig#L1-L3)
- [Flutter-Debug.xcconfig](file://app/macos/Flutter/Flutter-Debug.xcconfig#L1-L3)

### 构建变体功能差异
不同构建变体在功能和权限上存在差异：

```mermaid
table
| 构建变体 | JIT执行 | 沙盒 | 应用组 | 网络权限 | 文件访问 |
|---------|--------|------|-------|---------|---------|
| Debug/Profile | 启用 | 启用 | 启用 | 启用 | 启用 |
| Release | 禁用 | 启用 | 启用 | 启用 | 启用 |
```

**Section sources**
- [Release.entitlements](file://app/macos/Runner/Release.entitlements#L1-L23)
- [DebugProfile.entitlements](file://app/macos/Runner/DebugProfile.entitlements#L1-L23)

## 常见构建错误排查

### 签名失败问题
签名失败是常见的构建问题，可能由多种原因引起。

```mermaid
flowchart TD
A[签名失败] --> B{证书问题}
A --> C{权限问题}
A --> D{配置问题}
B --> B1[证书过期]
B --> B2[证书不匹配]
B --> B3[密钥链访问]
C --> C1[权限不足]
C --> C2[沙盒限制]
C --> C3[文件访问]
D --> D1[Entitlements配置]
D --> D2[签名标识]
D --> D3[团队ID]
```

**Section sources**
- [compile_mac_dmg.sh](file://scripts/compile_mac_dmg.sh#L1-L53)

### 架构不匹配问题
架构不匹配可能导致构建失败或运行时错误。

```mermaid
flowchart TD
A[架构不匹配] --> B{目标架构}
B --> B1[x86_64]
B --> B2[arm64]
B --> B3[通用二进制]
C[构建环境] --> C1[Intel Mac]
C --> C2[Apple Silicon Mac]
D[解决方案] --> D1[交叉编译]
D --> D2[lipo合并]
D --> D3[统一架构]
```

**Section sources**
- [build_pod.sh](file://app/rust_builder/cargokit/build_pod.sh#L1-L57)

## 结论
LocalSend项目的macOS构建和部署流程设计完善，通过自动化脚本实现了从代码构建到分发的完整流程。项目使用CocoaPods管理原生依赖，通过Entitlements文件配置安全权限，并实现了完整的代码签名和公证流程。开发者可以根据不同需求选择合适的构建变体，并通过详细的错误排查指南解决常见问题。