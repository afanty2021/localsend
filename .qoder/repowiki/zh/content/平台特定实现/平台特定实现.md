# 平台特定实现

<cite>
**本文档中引用的文件**  
- [AndroidManifest.xml](file://app/android/app/src/main/AndroidManifest.xml)
- [build.gradle](file://app/android/app/build.gradle)
- [Info.plist](file://app/ios/Runner/Info.plist)
- [Podfile](file://app/ios/Podfile)
- [CMakeLists.txt](file://app/linux/CMakeLists.txt)
- [main.cpp](file://app/windows/runner/main.cpp)
- [pubspec.yaml](file://app/pubspec.yaml)
- [compile_android_apk.sh](file://scripts/compile_android_apk.sh)
- [compile_ios.sh](file://scripts/compile_ios.sh)
- [install_msix_helper.ps1](file://app/windows/install_msix_helper.ps1)
</cite>

## 目录
1. [介绍](#介绍)
2. [Android 实现](#android-实现)
3. [iOS 实现](#ios-实现)
4. [Windows 实现](#windows-实现)
5. [macOS 实现](#macos-实现)
6. [Linux 实现](#linux-实现)
7. [构建与打包指南](#构建与打包指南)
8. [常见问题与调试技巧](#常见问题与调试技巧)

## 介绍
LocalSend 是一个开源的跨平台文件共享应用，支持 Android、iOS、Windows、macOS 和 Linux 平台。本文档详细描述了各平台的特定实现细节，包括原生代码集成、权限配置、后台服务实现和用户界面适配。

## Android 实现

### 原生代码集成与权限配置
Android 实现基于 Flutter 框架，通过原生 AndroidManifest.xml 文件配置应用权限和功能。应用请求了多种权限以支持文件访问和网络通信功能。

在 `AndroidManifest.xml` 中，应用声明了以下权限：
- 网络访问权限：`android.permission.INTERNET`
- 外部存储读写权限：`READ_EXTERNAL_STORAGE` 和 `WRITE_EXTERNAL_STORAGE`
- 媒体文件访问权限：`READ_MEDIA_IMAGES` 和 `READ_MEDIA_VIDEO`
- 位置信息访问权限：`ACCESS_MEDIA_LOCATION`
- 应用包查询和安装权限：`QUERY_ALL_PACKAGES` 和 `REQUEST_INSTALL_PACKAGES`

这些权限确保应用能够访问设备上的文件并与其他设备进行通信。

### 后台服务与用户界面适配
Android 应用通过设置 `android:launchMode="singleTask"` 防止多个实例同时运行。应用支持 Android TV，通过声明 `android.software.leanback` 特性实现电视设备兼容性。

应用还实现了分享功能，通过定义 SEND 和 SEND_MULTIPLE 意图过滤器，允许其他应用将内容分享到 LocalSend。

**Section sources**
- [AndroidManifest.xml](file://app/android/app/src/main/AndroidManifest.xml#L1-L75)
- [build.gradle](file://app/android/app/build.gradle#L1-L103)

## iOS 实现

### 权限请求与后台模式
iOS 实现通过 Info.plist 文件配置应用权限和功能。应用需要请求用户授权才能访问特定资源。

在 `Info.plist` 中，应用配置了以下权限描述：
- 照片库访问权限：`NSPhotoLibraryUsageDescription`
- 照片库添加权限：`NSPhotoLibraryAddUsageDescription`
- 位置信息访问权限：`NSLocationWhenInUseUsageDescription`
- 本地网络访问权限：`NSLocalNetworkUsageDescription`

这些描述文本会在请求相应权限时显示给用户，解释为什么需要这些权限。

### Bonjour 服务与文件共享
应用使用 Bonjour 服务进行设备发现，通过在 `NSBonjourServices` 数组中声明 `_http._tcp`、`_bonjour._tcp` 和 `_lnp._tcp` 服务类型实现。

应用还启用了文档浏览器支持（`UISupportsDocumentBrowser`）和文件共享功能（`UIFileSharingEnabled`），使用户可以在文件应用中访问接收的文件。

**Section sources**
- [Info.plist](file://app/ios/Runner/Info.plist#L1-L155)
- [Podfile](file://app/ios/Podfile#L1-L49)

## Windows 实现

### 系统托盘集成
Windows 实现使用 `tray_manager` 插件实现系统托盘集成。应用在系统托盘中显示图标，允许用户快速访问应用功能而不需要保持主窗口打开。

### 原生代码与命令行参数处理
在 `main.cpp` 中，应用处理命令行参数和共享数据。通过 `IsRunningWithIdentity()` 和 `GetSharedMedia()` 函数检测是否通过共享扩展启动，并获取共享的内容。

应用还初始化了 COM 库（`CoInitializeEx`），为插件和库提供必要的支持。

### MSIX 安装支持
应用提供了 MSIX 安装支持，通过 `install_msix_helper.ps1` 脚本安装 MSIX 包。这使得应用可以通过 Microsoft Store 分发或侧载安装。

**Section sources**
- [main.cpp](file://app/windows/runner/main.cpp#L1-L54)
- [install_msix_helper.ps1](file://app/windows/install_msix_helper.ps1#L1-L1)

## macOS 实现

### 状态栏图标与 Dock 集成
macOS 实现使用 `tray_manager` 插件在状态栏显示图标。应用设置 `LSUIElement` 为 `true`，使其作为菜单栏应用运行，不显示在 Dock 中。

### 服务扩展与文件类型关联
应用通过 `NSServices` 配置系统服务，允许用户在其他应用中通过"服务"菜单将文本发送到 LocalSend。

应用还配置了文档类型关联，支持处理各种文件类型。通过 `CFBundleDocumentTypes` 配置，应用可以作为文件查看器处理公共数据类型。

### 权限与网络配置
与 iOS 类似，macOS 应用需要请求照片库、位置和本地网络访问权限。`NSLocalNetworkUsageDescription` 权限允许应用在本地网络中发现和连接其他设备。

**Section sources**
- [Info.plist](file://app/macos/Runner/Info.plist#L1-L159)
- [Podfile](file://app/macos/Podfile#L1-L46)

## Linux 实现

### 桌面环境集成
Linux 实现基于 GTK+ 3.0，通过 CMakeLists.txt 配置构建系统。应用使用标准的 Linux 桌面集成方法，包括应用标识符和图标配置。

### 构建系统配置
CMakeLists.txt 文件配置了应用的构建过程，包括：
- 设置最低 CMake 版本要求（3.10）
- 定义应用名称和唯一标识符
- 配置编译选项和优化级别
- 管理依赖库（GTK+ 3.0）
- 设置安装路径和资源目录

构建系统还处理 Flutter 插件的集成，通过包含 `generated_plugins.cmake` 文件自动注册所有插件。

### 运行时依赖管理
应用在运行时从相对路径加载库（`$ORIGIN/lib`），确保所有依赖库都能正确找到。构建系统还负责复制 ICU 数据文件、Flutter 库和 AOT 编译的 Dart 代码。

**Section sources**
- [CMakeLists.txt](file://app/linux/CMakeLists.txt#L1-L140)

## 构建与打包指南

### Android 构建流程
Android 应用通过 Gradle 构建系统进行构建。`build.gradle` 文件配置了：
- 编译 SDK 版本（34）
- Java 和 Kotlin 编译目标版本（17）
- 应用 ID、版本号和版本名称
- 签名配置（用于发布版本）

构建脚本 `compile_android_apk.sh` 提供了完整的构建流程，包括：
1. 清理和复制项目
2. 初始化 Flutter 子模块
3. 获取依赖包
4. 运行代码生成器
5. 构建 APK

应用支持多种 ABI（x86_64、armeabi-v7a、arm64-v8a），通过版本代码偏移实现多架构支持。

### iOS 构建流程
iOS 应用通过 Xcode 构建系统进行构建。`Podfile` 配置了：
- 最低 iOS 版本要求（12.0）
- CocoaPods 依赖管理
- Flutter 插件集成

构建脚本 `compile_ios.sh` 提供了构建流程：
1. 清理和获取依赖
2. 预缓存 iOS 构建资源
3. 更新 CocoaPods 依赖
4. 构建 IPA 文件

### 桌面平台构建
Windows、macOS 和 Linux 平台都使用各自的原生构建系统与 Flutter 集成。所有平台都通过 `pubspec.yaml` 管理 Dart 依赖，并使用平台特定的构建配置文件。

**Section sources**
- [build.gradle](file://app/android/app/build.gradle#L1-L103)
- [compile_android_apk.sh](file://scripts/compile_android_apk.sh#L1-L32)
- [compile_ios.sh](file://scripts/compile_ios.sh#L1-L14)
- [pubspec.yaml](file://app/pubspec.yaml#L1-L124)

## 常见问题与调试技巧

### 权限相关问题
- **Android**: 确保在 AndroidManifest.xml 中正确声明所有必要权限，并在运行时请求危险权限。
- **iOS/macOS**: 检查 Info.plist 中的权限描述是否完整，确保用户理解权限请求的原因。
- **Windows**: 注意某些权限（如文件系统访问）可能受用户账户控制（UAC）限制。

### 网络发现问题
- 确保本地网络权限已授予
- 检查防火墙设置是否阻止了应用的网络通信
- 验证 Bonjour/mDNS 服务是否正常工作

### 构建问题
- **Android**: 确保 Android SDK 和 NDK 版本兼容
- **iOS**: 确保 Xcode 命令行工具已正确安装
- **Linux**: 确保所有构建依赖（如 GTK+ 开发库）已安装

### 调试技巧
- 使用平台特定的日志工具（Android Logcat、Xcode Console、Windows Event Viewer）
- 启用 Flutter 的调试模式以获取详细的 Dart 代码日志
- 检查原生代码的编译警告和错误

**Section sources**
- [AndroidManifest.xml](file://app/android/app/src/main/AndroidManifest.xml#L1-L75)
- [Info.plist](file://app/ios/Runner/Info.plist#L1-L155)
- [Info.plist](file://app/macos/Runner/Info.plist#L1-L159)