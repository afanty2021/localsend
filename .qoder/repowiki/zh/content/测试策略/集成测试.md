# 集成测试

<cite>
**本文档中引用的文件**  
- [server_provider.dart](file://app/lib/provider/network/server/server_provider.dart)
- [send_controller.dart](file://app/lib/provider/network/server/controller/send_controller.dart)
- [mocks.dart](file://app/test/mocks.dart)
- [mocks.mocks.dart](file://app/test/mocks.mocks.dart)
- [device.dart](file://common/lib/model/device.dart)
- [discovery.rs](file://core/src/model/discovery.rs)
- [transfer.rs](file://core/src/model/transfer.rs)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构概述](#架构概述)
5. [详细组件分析](#详细组件分析)
6. [依赖分析](#依赖分析)
7. [性能考虑](#性能考虑)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)

## 简介
本文档详细描述了LocalSend应用的集成测试策略，重点在于验证UI层、业务逻辑层和数据层之间的交互。文档涵盖了设备发现、会话建立、文件传输和错误处理等关键场景的测试用例，并说明了如何使用真实或部分模拟的依赖来测试组件间的集成，同时保持测试的稳定性和速度。

## 项目结构
LocalSend项目采用分层架构，包含Flutter前端、Rust后端和共享的Dart核心模块。集成测试主要集中在验证这些层之间的交互。

```mermaid
graph TB
subgraph "Flutter前端"
UI[用户界面]
Provider[状态管理]
Util[工具类]
end
subgraph "Rust后端"
Core[核心逻辑]
Server[服务器]
end
subgraph "共享模块"
Common[通用模型]
DTO[数据传输对象]
end
UI --> Provider
Provider --> Util
Provider --> Core
Core --> Server
Common --> Core
Common --> Provider
```

**图源**  
- [server_provider.dart](file://app/lib/provider/network/server/server_provider.dart)
- [device.dart](file://common/lib/model/device.dart)

**本节来源**  
- [server_provider.dart](file://app/lib/provider/network/server/server_provider.dart)
- [device.dart](file://common/lib/model/device.dart)

## 核心组件
集成测试的核心是验证服务器提供者、发送控制器和接收控制器之间的交互。这些组件负责处理从设备发现到文件传输的完整流程。

**本节来源**  
- [server_provider.dart](file://app/lib/provider/network/server/server_provider.dart)
- [send_controller.dart](file://app/lib/provider/network/server/controller/send_controller.dart)

## 架构概述
系统采用客户端-服务器架构，通过HTTP和WebSocket协议进行通信。集成测试需要验证整个通信链路的正确性。

```mermaid
sequenceDiagram
participant Client as "客户端应用"
participant Provider as "ServerProvider"
participant Controller as "SendController"
participant Server as "Rust服务器"
Client->>Provider : 启动服务器
Provider->>Provider : 创建ServerState
Provider->>Controller : 安装路由
Controller->>Server : 绑定HTTP服务器
Server-->>Provider : 服务器启动成功
Provider->>Client : 通知服务器状态更新
```

**图源**  
- [server_provider.dart](file://app/lib/provider/network/server/server_provider.dart)
- [send_controller.dart](file://app/lib/provider/network/server/controller/send_controller.dart)

## 详细组件分析

### 服务器提供者分析
服务器提供者是集成测试的关键组件，负责管理服务器状态和协调各个控制器。

```mermaid
classDiagram
class ServerProvider {
+ServerState? state
+startServer()
+stopServer()
+restartServer()
+acceptFileRequest()
+declineFileRequest()
}
class ServerState {
+SimpleServer httpServer
+String alias
+int port
+bool https
+ReceiveSessionState? session
+WebSendState? webSendState
+Map<String, int> pinAttempts
}
class SendController {
+installRoutes()
+initializeWebSend()
+acceptRequest()
+declineRequest()
}
ServerProvider --> ServerState : "拥有"
ServerProvider --> SendController : "使用"
SendController --> ServerState : "更新"
```

**图源**  
- [server_provider.dart](file://app/lib/provider/network/server/server_provider.dart)
- [send_controller.dart](file://app/lib/provider/network/server/controller/send_controller.dart)

### 设备发现与会话建立
集成测试需要验证设备发现和会话建立的完整流程。

```mermaid
flowchart TD
Start([开始文件传输]) --> Discover["发现目标设备"]
Discover --> Found{"设备找到?"}
Found --> |否| Retry["重试发现"]
Found --> |是| Connect["建立WebSocket连接"]
Connect --> Auth["验证设备指纹"]
Auth --> Valid{"指纹有效?"}
Valid --> |否| Reject["拒绝连接"]
Valid --> |是| Negotiate["协商传输参数"]
Negotiate --> Ready["准备文件传输"]
Ready --> End([会话建立完成])
```

**图源**  
- [discovery.rs](file://core/src/model/discovery.rs)
- [device.dart](file://common/lib/model/device.dart)

### 文件传输流程
文件传输是集成测试的核心场景，需要验证从请求到完成的完整流程。

```mermaid
sequenceDiagram
participant Sender as "发送方"
participant Receiver as "接收方"
Sender->>Receiver : 发送文件请求
Receiver->>Receiver : 显示接收确认对话框
Receiver->>Sender : 用户接受/拒绝
alt 用户接受
Sender->>Receiver : 开始文件传输
loop 每个文件
Sender->>Receiver : 发送文件块
Receiver->>Sender : 确认接收
end
Receiver->>Sender : 传输完成确认
else 用户拒绝
Receiver->>Sender : 拒绝响应
end
```

**图源**  
- [send_controller.dart](file://app/lib/provider/network/server/controller/send_controller.dart)
- [transfer.rs](file://core/src/model/transfer.rs)

**本节来源**  
- [send_controller.dart](file://app/lib/provider/network/server/controller/send_controller.dart)
- [transfer.rs](file://core/src/model/transfer.rs)

## 依赖分析
集成测试需要管理多个依赖关系，包括网络通信、状态管理和数据持久化。

```mermaid
graph TD
A[UI层] --> B[Provider层]
B --> C[网络通信]
B --> D[状态管理]
B --> E[文件系统]
C --> F[Rust后端]
F --> G[HTTP服务器]
F --> H[WebSocket]
D --> I[SharedPreferences]
E --> J[本地存储]
style A fill:#f9f,stroke:#333
style B fill:#bbf,stroke:#333
style C fill:#f96,stroke:#333
style D fill:#6f9,stroke:#333
style E fill:#96f,stroke:#333
```

**图源**  
- [server_provider.dart](file://app/lib/provider/network/server/server_provider.dart)
- [mocks.dart](file://app/test/mocks.dart)

**本节来源**  
- [server_provider.dart](file://app/lib/provider/network/server/server_provider.dart)
- [mocks.dart](file://app/test/mocks.dart)

## 性能考虑
集成测试需要考虑性能因素，确保测试既全面又高效。

- **测试隔离**: 每个测试用例应该独立运行，避免相互影响
- **资源清理**: 测试完成后及时释放网络端口和文件句柄
- **超时设置**: 为网络操作设置合理的超时时间
- **并发测试**: 避免同时运行多个占用相同端口的测试

## 故障排除指南
集成测试中常见的问题和解决方案。

**本节来源**  
- [server_provider.dart](file://app/lib/provider/network/server/server_provider.dart)
- [send_controller.dart](file://app/lib/provider/network/server/controller/send_controller.dart)

## 结论
集成测试在LocalSend项目中扮演着至关重要的角色，能够有效发现接口不匹配和集成缺陷。通过验证UI层、业务逻辑层和数据层的协同工作，确保了从设备发现到文件传输的完整流程的可靠性。建议持续完善集成测试套件，覆盖更多边界情况和错误处理场景。